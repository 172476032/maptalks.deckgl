/*!
 * maptalks.deckgl v0.0.0
 * LICENSE : MIT
 * (c) 2016-2017 maptalks.org
 */
/*!
 * requires maptalks@^0.25.1 
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("maptalks"),require("deck.gl")):"function"==typeof define&&define.amd?define(["exports","maptalks","deck.gl"],t):t(e.maptalks=e.maptalks||{},e.maptalks,e.deck_gl)}(this,function(e,t,r){"use strict";function a(e,t){for(var r=Object.getOwnPropertyNames(t),a=0;a<r.length;a++){var n=r[a],i=Object.getOwnPropertyDescriptor(t,n);i&&i.configurable&&void 0===e[n]&&Object.defineProperty(e,n,i)}return e}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):a(e,t))}var s={renderer:"webgl",doubleBuffer:!0,glOptions:null},c=Math.PI/180,h=function(e){function t(){return n(this,t),i(this,e.apply(this,arguments))}return o(t,e),t}(t.CanvasLayer);h.mergeOptions(s);var p=function(e){function a(){return n(this,a),i(this,e.apply(this,arguments))}return o(a,e),a.prototype.draw=function(){e.prototype.draw.call(this),this.renderScene()},a.prototype.drawOnInteracting=function(){e.prototype.drawOnInteracting.call(this),this.renderScene()},a.prototype.getPrepareParams=function(){return[this.layerManager]},a.prototype.getDrawParams=function(){return[this.layerManager]},a.prototype.createCanvas=function(){if(!this.canvas){var e=this.getMap(),r=e.getSize(),a=t.Browser.retina?2:1;this.canvas=t.Canvas.createCanvas(a*r.width,a*r.height,e.CanvasClass);(this.gl=this._createGLContext(this.canvas,this.layer.options.glOptions)).clearColor(0,0,0,0),this.onCanvasCreate&&this.onCanvasCreate(),this.layer.options.doubleBuffer&&(this.buffer=t.Canvas.createCanvas(this.canvas.width,this.canvas.height,e.CanvasClass),this.context=this.buffer.getContext("2d"))}},a.prototype.resizeCanvas=function(e){if(this.canvas){var r=void 0;r=e||this.getMap().getSize();var a=t.Browser.retina?2:1;this.canvas.height=a*r.height,this.canvas.width=a*r.width,this.gl.viewport(0,0,this.canvas.width,this.canvas.height)}},a.prototype.clearCanvas=function(){this.canvas&&(this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT),this.context&&this.context.clearRect(0,0,this.canvas.width,this.canvas.height))},a.prototype.prepareCanvas=function(){return this.context?e.prototype.prepareCanvas.call(this):(this.canvas?this.clearCanvas():this.createCanvas(),this.layer.fire("renderstart",{context:this.context,gl:this.gl}),null)},a.prototype.getTargetZoom=function(e){return e.getMaxNativeZoom()/2},a.prototype._getLookAtMat=function(){var e=this.getMap(),t=this.getTargetZoom(e),r=e.getSize(),a=e.getScale()/e.getScale(t),n=this.cameraCenter=e.coordinateToPoint(e.getCenter(),t),i=e.getPitch()*c,o=-e.getBearing()*c,s=this._getFovRatio(),h=a*r.height/2/s,p=h*Math.cos(i),l=Math.sin(i)*h;return{eye:[n.x+l*Math.sin(o),n.y+l*Math.cos(o),p],fov:s,width:r.width,height:r.height}},a.prototype.onCanvasCreate=function(){var e=this._getLookAtMat(),t=new r.PerspectiveViewport(e),a=new r.LayerManager({gl:this.gl});a.setViewport(t),this.layerManager=a},a.prototype.onRemove=function(){},a.prototype.renderScene=function(){var e=this._getLookAtMat(),t=new r.PerspectiveViewport(e);this.layerManager.setViewport(t),this.layerManager.updateLayers(),this.completeRender()},a}(t.renderer.CanvasLayerRenderer);h.registerRenderer("canvas",p),h.registerRenderer("webgl",p),e.DeckGLLayer=h,e.DeckGLRenderer=p,Object.defineProperty(e,"__esModule",{value:!0}),"undefined"!=typeof console&&console.log("maptalks.deckgl v0.0.0, requires maptalks@^0.25.1.")});